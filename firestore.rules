rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth.token.email == 'itschaidev@gmail.com';
    }
    
    
    // Allow users to read and write their own tasks
    match /tasks/{taskId} {
      // Allow read for authenticated users (they can only see their own via query)
      allow read: if isAuthenticated() || true; // Allow server-side access too
      // Allow write/update if user owns the task OR if it's a routine task being reset by cron
      allow write, update: if (isAuthenticated() && (isOwner(resource.data.userId) || isAdmin())) 
                           || (resource.data.isRoutine == true); // Allow server-side routine resets
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      // Allow create if user is creating their own task
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
    }
    
    // Allow users to read and write their own user profile
    match /users/{userId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.uid) || isAdmin());
    }
    
        // Allow server-side access to scheduled notifications (for cron jobs)
        // This is the only collection that needs server-side access without auth
        match /scheduled_notifications/{notificationId} {
          // Allow all operations for server-side notification processing
          // This is necessary for the cron job to work
          allow read, write, create, delete: if true;
        }
        
        // Allow server-side access to reminders (for reminder worker)
        match /reminders/{reminderId} {
          // Allow all operations for server-side reminder processing
          // This is necessary for the reminder worker to work
          allow read, write, create, delete: if true;
        }
        
        // Allow server-side access to simple notifications (for new notification system)
        match /simple_notifications/{notificationId} {
          // Allow all operations for server-side notification processing
          // This is necessary for the simple notification system to work
          allow read, write, create, delete: if true;
        }
    
    // Allow chat messages for authenticated users
    match /chats/{chatId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
    }
    
    // Allow messages within chats
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
    }
    
    // Allow users to read and write their own preferences
    match /userPreferences/{userId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
    }
    
    // Routines - users can manage their own routines
    match /routines/{routineId} {
      allow read: if isAuthenticated();
      allow write, update, delete: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // User Credits - users can read/write their own credits
    match /user_credits/{userId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // User Achievements - users can read/write their own achievements
    // Allow server-side access for achievement checking
    match /user_achievements/{userId} {
      allow read: if isAuthenticated() && 
        (isOwner(userId) || isAdmin()) || true; // Allow server-side reads
      allow write, update: if isAuthenticated() && 
        (isOwner(userId) || isAdmin()) || true; // Allow server-side writes
      allow create: if isAuthenticated() && 
        (isOwner(userId) || isAdmin()) || true; // Allow server-side creates
    }
    
    // Credit Transactions - users can read their own transactions
    match /credit_transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
    }
    
    // User Tutorials - users can read/write their own tutorial progress
    match /user_tutorials/{userId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // User Settings - timezone and other user-specific settings
    match /user_settings/{userId} {
      allow read: if isAuthenticated() || true; // Allow bot server access
      allow write, create: if isAuthenticated() || true; // Allow bot server access
    }
    
    // Routine Completions - track daily routine completions (exploit prevention)
    match /routine_completions/{completionId} {
      allow read: if true; // Allow server-side reads from cron job
      allow create: if isAuthenticated() && 
        (isOwner(request.resource.data.userId) || isAdmin());
      allow delete: if true; // Allow server-side deletes from cron job for resets
    }
    
    // Routine Settings - user preferences for reset time and notifications
    match /routine_settings/{userId} {
      allow read: if true; // Allow server-side reads from cron job
      allow write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // Last Resets - track when routines were last reset
    match /last_resets/{userId} {
      allow read, write, create, delete: if true; // Allow server-side access from cron
    }
    
    // Daily Claims - track daily credit claims
    match /daily_claims/{userId} {
      allow read, write: if isAuthenticated() && 
        (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated();
    }
    
    // Discord Links - link Discord accounts to Firebase UIDs
    match /discord_links/{discordId} {
      allow read: if isAuthenticated() || true; // Allow bot server access
      allow write, create, delete: if isAuthenticated() || true; // Allow bot server access
    }
    
    // Redemptions - track reward redemptions
    match /redemptions/{redemptionId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.uid) || isAdmin());
      allow create: if isAuthenticated() || true; // Allow bot server access
    }
    
    // Collaborations - users can read/write collaborations they're members of
    match /collaborations/{collabId} {
      allow read: if isAuthenticated(); // Members can read (filtered by query)
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (isOwner(resource.data.ownerId) || isAdmin());
    }
    
    // Collaboration Members - users can read members of their collaborations
    match /collaboration_members/{memberId} {
      allow read: if isAuthenticated(); // Members can read (filtered by query)
      allow create: if isAuthenticated(); // Anyone can create (invitations)
      allow update: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin() || 
         (exists(/databases/$(database)/documents/collaborations/$(resource.data.collabId)) &&
         get(/databases/$(database)/documents/collaborations/$(resource.data.collabId)).data.ownerId == request.auth.uid));
      allow delete: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin() || 
         (exists(/databases/$(database)/documents/collaborations/$(resource.data.collabId)) &&
         get(/databases/$(database)/documents/collaborations/$(resource.data.collabId)).data.ownerId == request.auth.uid));
    }
    
    // Collaboration Roles - users can read roles of their collaborations
    match /collaboration_roles/{roleId} {
      allow read: if isAuthenticated(); // Members can read (filtered by query)
      allow create: if isAuthenticated(); // Allow creation during collab setup (ownership validated in code)
      allow update, delete: if isAuthenticated() && 
        ((exists(/databases/$(database)/documents/collaborations/$(resource.data.collabId)) &&
         get(/databases/$(database)/documents/collaborations/$(resource.data.collabId)).data.ownerId == request.auth.uid) ||
        isAdmin());
    }
    
    // Collaboration Tasks - users can read/write tasks in their collaborations
    match /collaboration_tasks/{taskId} {
      allow read: if isAuthenticated(); // Members can read (filtered by query)
      allow create, update, delete: if isAuthenticated(); // Members can manage tasks
    }
    
    // Collaboration Messages - users can read/write messages in their collaborations
    match /collaboration_messages/{messageId} {
      allow read: if isAuthenticated(); // Members can read (filtered by query)
      allow create: if isAuthenticated(); // Anyone authenticated can create messages
      allow update, delete: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin() || resource.data.userId == '' || resource.data.isCompanion == true);
    }
    
    // Collaboration Invites - users can read invites for their collaborations, create/update/delete if owner
    match /collaboration_invites/{inviteId} {
      allow read: if isAuthenticated(); // Anyone authenticated can read (to accept invites)
      // Allow create if user is authenticated and createdBy matches their uid
      // The client code should verify they're the owner before calling this
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      // Allow update/delete if user created the invite or is admin
      allow update, delete: if isAuthenticated() && 
        (isOwner(resource.data.createdBy) || isAdmin());
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
